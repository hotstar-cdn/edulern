<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Community Talk</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet"/>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Roboto, sans-serif; height: 100vh; display: flex; flex-direction: column; background: #ece5dd; }
    /* Header */
    header {
      height: 60px; background: #075e54; display: flex;
      align-items: center; padding: 0 10px; color: white;
    }
    header .back { font-size: 20px; margin-right: 15px; cursor: pointer; }
    header .chat-title { flex: 1; font-size: 18px; }
    header .status { font-size: 12px; }
    /* Chat Area */
    #chat { flex: 1; padding: 10px; overflow-y: auto; }
    .bubble {
      max-width: 80%; margin: 5px 0; padding: 8px 12px;
      border-radius: 7.5px; position: relative; word-wrap: break-word;
    }
    .sent { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 0; }
    .received { background: #fff; align-self: flex-start; border-bottom-left-radius: 0; }
    .bubble img { max-width: 100%; border-radius: 5px; margin-top: 5px; }
    .meta { font-size: 10px; color: #555; margin-top: 3px; text-align: right; }
    .seen { font-size: 9px; color: #777; margin-top: 3px; text-align: right; }
    /* Input */
    .input-bar {
      background: #fff; padding: 5px 10px; display: flex; align-items: center;
      position: relative;
    }
    .input-bar input[type="text"] {
      flex: 1; padding: 8px; border-radius: 20px; border: none;
      background: #f0f0f0; margin: 0 10px;
    }
    .input-bar input[type="file"] { display: none; }
    .input-bar .attach {
      font-size: 20px; color: #075e54; cursor: pointer;
    }
    .input-bar .send-btn {
      position: absolute; right: 15px; background: #25d366; color: white;
      border: none; padding: 8px; border-radius: 50%; font-size: 18px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    /* Username Modal */
    #usernameModal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: flex; justify-content: center; align-items: center;
    }
    #usernameBox {
      background: white; padding: 20px; border-radius: 10px;
      width: 90%; max-width: 300px; text-align: center;
    }
    /* Reaction Picker */
    #reactPicker {
      position: absolute; background: #fff; border: 1px solid #ccc;
      border-radius: 10px; padding: 5px; display: none;
    }
    #reactPicker span { font-size: 24px; margin: 2px; cursor: pointer; }

    @media(max-width:600px){
      header { padding: 0 5px; }
      .bubble { max-width: 90%; }
      .input-bar .send-btn { right: 10px; padding: 6px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="back">&#8592;</div>
    <div class="chat-title">Community Talk</div>
    <div class="status">Loading...</div>
  </header>

  <div id="chat"></div>

  <div class="input-bar">
    <label class="attach" for="file">&#128247;</label>
    <input type="file" id="file" accept="image/*" />
    <input type="text" id="msg" placeholder="Type a message" />
    <button class="send-btn" id="sendBtn">&#9658;</button>
  </div>

  <div id="usernameModal">
    <div id="usernameBox">
      <h3>Enter your name</h3>
      <input type="text" id="usernameInput"/>
      <br/><br/>
      <button onclick="saveUsername()">Start</button>
    </div>
  </div>

  <div id="reactPicker"><span>üëç</span><span>‚ù§Ô∏è</span><span>üòÇ</span><span>üòÆ</span></div>
  <audio id="ping" src="https://notificationsounds.com/storage/sounds/file-sounds-1154-pristine.mp3" preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script>
    const config = {
      apiKey:"AIzaSyAX27di1k3zuHMdFVtuzFjqAnXKb-Juo7Y",
      authDomain:"community-edulearn.firebaseapp.com",
      projectId:"community-edulearn",
      storageBucket:"community-edulearn.firebasestorage.app",
      messagingSenderId:"517780625337",
      appId:"1:517780625337:web:b4d491cfe8057aa0dd4868",
      measurementId:"G-7T47TFT2ZX"
    };
    firebase.initializeApp(config);
    const db = firebase.firestore(), storage = firebase.storage();
    let username = localStorage.getItem('ctUser');
    const chat = document.getElementById('chat'), statusDiv = document.querySelector('.status');

    if(!username){
      document.getElementById('usernameModal').style.display='flex';
    } else init();

    function saveUsername(){
      const v = document.getElementById('usernameInput').value.trim();
      if(!v) return;
      username = v;
      localStorage.setItem('ctUser',v);
      db.collection('presence').doc(username).set({online:true});
      document.getElementById('usernameModal').style.display='none';
      init();
    }

    window.addEventListener('beforeunload',()=> db.collection('presence').doc(username).update({online:false}));

    function init(){
      document.getElementById('sendBtn').onclick = sendMsg;
      document.getElementById('msg').onkeydown = e => { if(e.key==='Enter') sendMsg(); };
      listenChats(); listenPresence();
      chat.addEventListener('click', msgClicked);
    }

    async function sendMsg(){
      const text = document.getElementById('msg').value.trim();
      const file = document.getElementById('file').files[0];
      let img='';
      if(file){
        let ref = storage.ref('imgs/'+Date.now()+'_'+file.name);
        await ref.put(file);
        img = await ref.getDownloadURL();
      }
      if(!text && !img) return;
      await db.collection('chats').add({
        name:username, text, img,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        seen:[], reactions:{}
      });
      document.getElementById('msg').value='';
      document.getElementById('file').value='';
    }

    function listenChats(){
      db.collection('chats').orderBy('ts')
        .onSnapshot(snap=>{
          chat.innerHTML='';
          snap.forEach(d=> renderMsg(d.id,d.data()));
          chat.scrollTop = chat.scrollHeight;
          document.getElementById('ping').play();
        });
    }

    function renderMsg(id,d){
      const b = document.createElement('div');
      b.className = 'bubble '+(d.name===username?'sent':'received');
      b.dataset.id = id;
      let html = `<b>${d.name}</b><br>`;
      if(d.text) html += `<div>${d.text}</div>`;
      if(d.img) html += `<img src="${d.img}"/>`;
      html += `<div class="meta">${new Date(d.ts?.toDate()).toLocaleTimeString()}</div>`;
      if(d.seen?.length) html += `<div class="seen">Seen: ${d.seen.join(', ')}</div>`;
      b.innerHTML = html;
      chat.appendChild(b);
      if(!d.seen?.includes(username)){
        db.collection('chats').doc(id).update({seen:firebase.firestore.FieldValue.arrayUnion(username)});
      }
    }

    const picker = document.getElementById('reactPicker');
    function msgClicked(e){
      const msgDiv = e.target.closest('.bubble');
      if(!msgDiv) return;
      const id = msgDiv.dataset.id;
      picker.style.display = 'flex';
      picker.style.left = e.pageX + 'px';
      picker.style.top = e.pageY + 'px';
      picker.onclick = ev => {
        if(ev.target.tagName==='SPAN'){
          db.collection('chats').doc(id)
            .update({[`reactions.${username}`]:ev.target.innerText});
        }
        picker.style.display = 'none';
      };
    }

    function listenPresence(){
      db.collection('presence').onSnapshot(snap=>{
        const online = [];
        snap.forEach(d=> { if(d.data().online) online.push(d.id); });
        statusDiv.innerText = 'Online: ' + online.join(', ');
      });
    }
  </script>
</body>
</html>

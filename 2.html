<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Community Talk</title>
  <style>
    :root {
      --bg: #f0f2f5;
      --text: #000;
      --sent: #dcf8c6;
      --received: #fff;
      --border: #ddd;
    }
    body.dark {
      --bg: #121212;
      --text: #eee;
      --sent: #2e7d32;
      --received: #1e1e1e;
      --border: #333;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      padding: 10px;
      background: var(--received);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    header button {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    #online-list {
      font-size: 14px;
    }
    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .message {
      display: inline-block;
      max-width: 75%;
      margin: 5px 0;
      padding: 10px;
      border-radius: 15px;
      position: relative;
      line-height: 1.4;
      border: 1px solid var(--border);
    }
    .sent { background: var(--sent); margin-left: auto; text-align: right; }
    .received { background: var(--received); margin-right: auto; text-align: left; }
    .message img {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 5px;
    }
    .timestamp {
      font-size: 10px;
      color: #555;
      margin-top: 5px;
    }
    .react-btn {
      cursor: pointer;
      margin: 0 2px;
    }
    .reactions {
      margin-top: 5px;
      font-size: 14px;
    }
    #typing-indicator {
      font-style: italic;
      color: #777;
      padding-left: 10px;
    }
    #input-area {
      display: flex;
      padding: 10px;
      border-top: 1px solid var(--border);
      background: var(--received);
    }
    #input-area input[type=text] {
      flex: 1; padding: 8px; font-size: 16px;
    }
    #input-area input[type=file] { margin-left: 5px; }
    #input-area button {
      margin-left: 5px;
      padding: 8px 16px;
      background: #0288d1;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 4px;
    }
    #username-prompt {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #username-box {
      background: var(--received);
      padding: 30px;
      border-radius: 10px;
      text-align: center;
    }
    #username-box input { padding: 10px; font-size: 18px; width: 200px; }
    #delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 12px;
      color: red;
      cursor: pointer;
    }
  </style>
</head>
<body>

<header>
  <div id="online-list">Online: 0</div>
  <button id="dark-toggle">üåô</button>
</header>

<div id="chat-box"></div>
<div id="typing-indicator"></div>

<div id="input-area">
  <input type="text" id="message-input" placeholder="Type a message..." oninput="userTyping()"/>
  <input type="file" id="image-input" accept="image/*"/>
  <button onclick="sendMessage()">Send</button>
</div>

<div id="username-prompt">
  <div id="username-box">
    <h2>Enter your name</h2>
    <input type="text" id="username-input" placeholder="Your name">
    <br><br>
    <button onclick="setUsername()">Continue</button>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAX27di1k3zuHMdFVtuzFjqAnXKb-Juo7Y",
    authDomain: "community-edulearn.firebaseapp.com",
    projectId: "community-edulearn",
    storageBucket: "community-edulearn.appspot.com",
    messagingSenderId: "517780625337",
    appId: "1:517780625337:web:b4d491cfe8057aa0dd4868",
    measurementId: "G-7T47TFT2ZX"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  let username = localStorage.getItem('community_username');
  if (!username) document.getElementById('username-prompt').style.display = 'flex';

  function setUsername(){
    const n = document.getElementById('username-input').value.trim();
    if (!n) return;
    username = n;
    localStorage.setItem('community_username', n);
    db.collection('users').doc(n).set({ name: n, online: true });
    document.getElementById('username-prompt').style.display = 'none';
    onlineStatus(true);
    detachWindowEvents();
    attachWindowEvents();
  }

  window.addEventListener('beforeunload', () => {
    if (username) db.collection('users').doc(username).update({ online: false });
  });

  function onlineStatus(on){
    if (username)
      db.collection('users').doc(username).update({ online: on });
  }
  function attachWindowEvents(){
    window.addEventListener('focus', () => onlineStatus(true));
    window.addEventListener('blur', () => onlineStatus(false));
  }
  function detachWindowEvents(){
    window.removeEventListener('focus', () => onlineStatus(true));
    window.removeEventListener('blur', () => onlineStatus(false));
  }

  function toggleDark(){
    const body = document.body;
    body.classList.toggle('dark');
    document.getElementById('dark-toggle').innerText = body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
  }
  document.getElementById('dark-toggle').onclick = toggleDark;

  async function sendMessage(){
    const text = document.getElementById('message-input').value.trim();
    const file = document.getElementById('image-input').files[0];
    let imgUrl = null;
    if (file){
      const ref = storage.ref('images/'+Date.now()+'_'+file.name);
      await ref.put(file);
      imgUrl = await ref.getDownloadURL();
    }
    if (!text && !imgUrl) return;

    await db.collection('chats').add({
      username, text, imgUrl,
      ts: firebase.firestore.FieldValue.serverTimestamp(),
      reactions: {}
    });
    document.getElementById('message-input').value = '';
    document.getElementById('image-input').value = '';
    db.collection('typing').doc("status").set({ [username]: false }, { merge: true });
  }

  function renderMessage(doc){
    const d = doc.data();
    const el = document.createElement('div');
    el.className = 'message ' + (d.username===username?'sent':'received');
    el.innerHTML = `<strong>${d.username}</strong><br>${d.text||''}`+
      (d.imgUrl?`<br><img src="${d.imgUrl}">`:'')+
      `<div class="timestamp">${d.ts?.toDate().toLocaleTimeString()}</div>`;
    if (d.username === username){
      const del = document.createElement('div');
      del.id = 'delete-btn';
      del.innerText = 'üóëÔ∏è';
      del.onclick = () => db.collection('chats').doc(doc.id).delete();
      el.appendChild(del);
    }
    const react = document.createElement('div');
    react.className = 'reactions';
    ['‚ù§Ô∏è','üòÇ','üëç'].forEach(emoji => {
      const btn = document.createElement('span');
      btn.innerText = emoji + (d.reactions?.[emoji]||'');
      btn.className = 'react-btn';
      btn.onclick = () => {
        const count = (d.reactions?.[emoji]||0) +1;
        db.collection('chats').doc(doc.id).update({ [`reactions.${emoji}`]: count });
      };
      react.appendChild(btn);
    });
    el.appendChild(react);
    document.getElementById('chat-box').appendChild(el);
  }

  document.getElementById('message-input').oninput = () => {
    db.collection('typing').doc("status").set({ [username]: true }, { merge: true });
    clearTimeout(window._typingTimeout);
    window._typingTimeout = setTimeout(()=> {
      db.collection('typing').doc("status").set({ [username]: false }, { merge: true });
    },3000);
  };

  db.collection('chats').orderBy('ts')
    .onSnapshot(snap=>{
      const box = document.getElementById('chat-box');
      box.innerHTML = '';
      snap.forEach(renderMessage);
      box.scrollTop = box.scrollHeight;
    });

  db.collection('typing').doc("status")
    .onSnapshot(doc=>{
      const data = doc.data()||{};
      const others = Object.keys(data).filter(n=>n!==username && data[n]);
      document.getElementById('typing-indicator').innerText = others.length ? `${others[0]} is typing...`:'';
    });

  db.collection('users').onSnapshot(snap=>{
    const online = snap.docs.filter(d=> d.data().online).map(d=> d.id);
    document.getElementById('online-list').innerText = 'Online: ' + online.join(', ');
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz in Progress</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="main-container">
        <div id="quiz-container">
            <!-- Content will be generated by JavaScript -->
        </div>
        <div id="error-container" style="display: none; padding: 20px; text-align: center;">
            <h2>Quiz not found</h2>
            <p>The quiz code provided in the URL is invalid or no questions were specified.</p>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const quizContainer = document.getElementById('quiz-container');
            const errorContainer = document.getElementById('error-container');

            let currentQuestionIndex = 0;
            let userAnswers = {};
            let quizQuestions = [];
            let quizCode = '';
            let quizStartTime;

            function initQuiz() {
                const params = new URLSearchParams(window.location.search);
                quizCode = params.get('code');
                const count = parseInt(params.get('count'), 10);

                if (!quizCode || !quizData[quizCode] || !count || count <= 0) {
                    quizContainer.style.display = 'none';
                    errorContainer.style.display = 'block';
                    return;
                }
                
                // Get the first 'count' questions (no shuffling as requested)
                quizQuestions = quizData[quizCode].questions.slice(0, count);

                if (quizQuestions.length === 0) {
                     quizContainer.style.display = 'none';
                    errorContainer.style.display = 'block';
                    return;
                }

                quizStartTime = new Date();
                displayQuestion();
            }

            function displayQuestion() {
                const question = quizQuestions[currentQuestionIndex];
                
                let optionsHtml = '';
                for (const option of question.options) {
                    const isSelected = userAnswers[question.id] === option.id;
                    optionsHtml += `
                        <button class="option ${isSelected ? 'selected' : ''}" data-option-id="${option.id}">
                            <div class="option-content">
                                <span class="option-id">${option.id}</span>
                                <div class="option-value">
                                    ${option.text ? `<span>${option.text}</span>` : ''}
                                    ${option.image ? `<div class="option-image"><img src="${option.image}" alt="Option ${option.id}"></div>` : ''}
                                </div>
                            </div>
                        </button>
                    `;
                }

                const quizHtml = `
                    <div class="header">
                        <h1>${quizData[quizCode].subject}</h1>
                        <div class="quiz-header">Question ${currentQuestionIndex + 1} of ${quizQuestions.length}</div>
                    </div>
                    <div class="content">
                        <div class="question-card">
                            <p class="question-text">${question.question_text}</p>
                            ${question.question_image ? `<div class="question-image"><img src="${question.question_image}" alt="Question Image"></div>` : ''}
                        </div>
                        <div class="options-container">
                            ${optionsHtml}
                        </div>
                        <div class="navigation-buttons">
                            <button class="btn btn-secondary" id="prev-btn" ${currentQuestionIndex === 0 ? 'disabled' : ''}>Previous</button>
                            ${currentQuestionIndex === quizQuestions.length - 1 
                                ? `<button class="btn btn-primary" id="submit-btn">Submit Test</button>`
                                : `<button class="btn btn-primary" id="next-btn">Next</button>`
                            }
                        </div>
                    </div>
                `;
                quizContainer.innerHTML = quizHtml;
                addEventListeners();
            }

            function addEventListeners() {
                document.querySelectorAll('.option').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const questionId = quizQuestions[currentQuestionIndex].id;
                        const optionId = e.currentTarget.dataset.optionId;
                        userAnswers[questionId] = optionId;
                        // Re-render to show selection
                        displayQuestion();
                    });
                });
                
                const nextBtn = document.getElementById('next-btn');
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        if (currentQuestionIndex < quizQuestions.length - 1) {
                            currentQuestionIndex++;
                            displayQuestion();
                        }
                    });
                }

                const prevBtn = document.getElementById('prev-btn');
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        if (currentQuestionIndex > 0) {
                            currentQuestionIndex--;
                            displayQuestion();
                        }
                    });
                }
                
                const submitBtn = document.getElementById('submit-btn');
                if(submitBtn) {
                    submitBtn.addEventListener('click', submitTest);
                }
            }
            
            function submitTest() {
                const quizEndTime = new Date();
                const totalTime = Math.round((quizEndTime - quizStartTime) / 1000); // in seconds
                
                const result = {
                    quizCode: quizCode,
                    questions: quizQuestions,
                    userAnswers: userAnswers,
                    totalTime: totalTime
                };
                
                localStorage.setItem('quizResult', JSON.stringify(result));
                window.location.href = '2_results.html';
            }

            initQuiz();
        });
    </script>
</body>
</html>
